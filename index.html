<script>
    if (!window.gameData) { alert("Could not load scenes.js"); }
    const scenes = window.gameData || {};

    const stage = document.getElementById('stage');
    // ... (Keep your DOM element references) ...
    const backBtn = document.getElementById('backBtn'); // Ensure this is defined
    const resetBtn = document.getElementById('resetBtn'); // Ensure this is defined
    const builderToggle = document.getElementById('builderToggle'); // Ensure this is defined
    
    let currentSceneId = 'main';
    let historyStack = [];
    let isAnimating = false;
    let isDrawing = false;
    let parentMap = {};

    function init() {
        if (!scenes['main']) return;

        buildParentMap();

        const urlParams = new URLSearchParams(window.location.search);
        const sceneParam = urlParams.get('scene');

        if (sceneParam && scenes[sceneParam]) {
            restoreState(sceneParam);
        } else {
            renderScene('main');
        }

        // ... (Keep your event listeners) ...
    }

    // ... (Keep helpers: getImagePath, buildParentMap, createImg, renderHotspots, clearHotspots, setAnimationVars, preloadNextImages, updateUI, goForward, goBack, reset, drawing logic) ...

    // --- CRITICAL FIX: SAFETY CHECK IN RENDER SCENE ---
    function renderScene(id) {
        stage.innerHTML = '';
        stage.appendChild(document.getElementById('selectionBox')); // Keep selection box
        
        const data = scenes[id];
        
        // 1. Recursive Size Lookup (WITH INFINITE LOOP PROTECTION)
        let width = data.width;
        let height = data.height;
        let curr = id;
        
        // Safety Set to track visited nodes during this lookup
        let checked = new Set();
        
        while ((!width || !height) && parentMap[curr]) {
            // STOP if we have seen this node before in this specific lookup chain
            if (checked.has(curr)) break;
            checked.add(curr);

            curr = parentMap[curr].parentId;
            if (scenes[curr]) {
                if (!width) width = scenes[curr].width;
                if (!height) height = scenes[curr].height;
            }
        }

        stage.style.width = width || '100%';
        stage.style.height = height || '100%';
        
        // 2. Render Image
        const imgPath = getImagePath(id);
        const img = createImg(imgPath, ['layer-image', 'active']);
        img.id = 'current-img';
        
        // 3. Render Hotspots
        if (data.hotspots) {
            renderHotspots(data.hotspots);
            preloadNextImages(data.hotspots);
        }
        
        currentSceneId = id;
        if(typeof updateUI === 'function') updateUI();
    }

    // --- CRITICAL FIX: SAFETY CHECK IN RESTORE STATE ---
    function restoreState(targetId) {
        if (targetId === 'main') {
            reset();
            return;
        }

        const path = [];
        let curr = targetId;
        
        // Safety Set for Deep Link reconstruction
        let checked = new Set();

        while (curr !== 'main') {
            // STOP if loop detected
            if (checked.has(curr)) {
                console.warn("Loop detected in navigation path. Stopping deep link trace.");
                break;
            }
            checked.add(curr);

            const parentInfo = parentMap[curr];
            if (!parentInfo) break;
            
            path.unshift({
                sceneId: parentInfo.parentId,
                type: parentInfo.type,
                hotspotUsed: parentInfo.hotspotData
            });
            curr = parentInfo.parentId;
        }

        historyStack = path;
        currentSceneId = targetId;
        // Assuming updateURL is defined in your full code
        const url = new URL(window.location);
        url.searchParams.set('scene', targetId);
        window.history.replaceState({ sceneId: targetId }, '', url);

        renderScene(targetId);
    }
    
    // ... (Rest of your code) ...
    init();
</script>
